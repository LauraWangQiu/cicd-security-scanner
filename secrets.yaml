name: Secret scanning

on:
  pull_request:
    branches: [ "main" ]

jobs:
  secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build scanner image
        run: docker build -t cicd-security-scanner .

      - name: Run secret scanning
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/scan \
            -e GITHUB_BASE_REF=${{ github.base_ref }} \
            cicd-security-scanner

      - name: Check if secrets were found
        id: check_secrets
        run: |
          if [ -f reports/gitleaks.json ]; then
            COUNT=$(jq 'length' reports/gitleaks.json 2>/dev/null || echo 0)
            if [ "$COUNT" -gt 0 ]; then
              echo "found=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          echo "found=false" >> $GITHUB_OUTPUT

      - name: Prepare artifact contents
        if: steps.check_secrets.outputs.found == 'true'
        run: |
          mkdir -p artifact
          cp reports/* artifact/
          {
            echo "repository=${{ github.repository }}"
            echo "commit_sha=${{ github.sha }}"
            echo "commit_url=https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          } > artifact/metadata.txt

      - name: Upload secret scanning reports
        if: steps.check_secrets.outputs.found == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ github.sha }}
          path: artifact

      - name: Comment on PR if secrets found
        if: steps.check_secrets.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âš ï¸ **Secret Scanning Alert** âš ï¸\n\nğŸ” Potential secrets have been detected in this PR!\n\n**Action Required:**\n- âŒ Do NOT merge this PR\n- ğŸ”„ **Rotate the exposed secret immediately** in your secret management system\n- ğŸ§¹ Remove the secret from the code\n- ğŸ“ Force push to update the commits\n- âœ… Re-run the scan to verify\n\nFor more details, check the [artifact reports](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).\n\n*This is an automated message from the Security Bot.*`
            })

      - name: Fail if secrets found
        if: steps.check_secrets.outputs.found == 'true'
        run: exit 1